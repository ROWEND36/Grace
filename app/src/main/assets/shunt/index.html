<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1.0" />
    <meta charset='utf-8' />
    <link rel="shortcut icon" href="./favicon.ico">
    <link rel="stylesheet" href="./libs/css/materialize.min.css">
    <script src="./libs/js/eruda.min.js"></script>

    <script>
        var lastErrorStack;
        eruda.init([]);
        var efg = console.log
        console.log = function(e) {
            efg(e);
            lastErrorStack = new Error().stack
        }
        if (!window.appStorage)
            window.appStorage = localStorage;
        //appStorage=null;
        var appConfig = {}

        function registerAll(configs) {
            for (var i in configs) {
                appConfig[i] = configs[i];
                register(i)
            }
        }

        function register(i) {
            if (appStorage.getItem(i)) {
                appConfig[i] = appStorage.getItem(i)
                if (appConfig[i] === "undefined") {
                    appConfig[i] = undefined
                }
                else if (appConfig[i] === "null") {
                    appConfig[i] = null
                }
                else if (appConfig[i] === "false") {
                    appConfig[i] = false
                }
            }
        }

        function configure(key, value) {
            appConfig[key] = value;
            appStorage.setItem("" + key, "" + value);
        }
    </script>
    <script>
        const unimplemented = function() {
            alert("Unimplemented");

        }
    </script>
    <!-- load ace -->
    <script src="./src-min-noconflict/ace.js"></script>
    <script src="./src-min-noconflict/ext-themelist.js"></script>
    <script src="./src-min-noconflict/ext-language_tools.js"></script>

    <script src="./src-min-noconflict/ext-settings_menu.js"></script>
    <script src="./src-min-noconflict/ext-htmlbeautify.js"></script>
    <script src="./src-min-noconflict/ext-modelist.js"></script>
    <script>
        var dom = ace.require("ace/lib/dom");
    </script>
    <script src="./main.js"></script>
    <script src="./fileBrowser.js"></script>
    <script src="search_tab.js" type="text/javascript" charset="utf-8"></script>

    <script src="./libs/js/jquery-2.2.0.min.js"></script>
    <script src="./libs/js/polyfill.js"></script>
    <script src="./libs/js/touchhold.js"></script>
    <script type="text/javascript" src="./libs/js/materialize.min.js"></script>
    <script type="text/javascript" src="./tabs.js"></script>
    <link rel="stylesheet" href="./main.css">
</head>

<body class="">

    <script>
        function addScript(path, callback) {
            var script = document.createElement("script");
            script.setAttribute("type", "text/javascript");
            document.head.appendChild(script);
            if (callback !== undefined)
                script.addEventListener("load", callback);
        }

        // addScript("./libs/js/materialize.min.js");
    </script>
    <div id="side-menu" class="clipboard-empty container sidenav">

        <ul id="selector" class="ui tabs row s12">
            <li class="tab col s4 center">
                <a href="#file-browser">
                    <i class="material-icons" style="width:100%">sd_storage</i></a>
            </li>
            <!--<li class="tab col s4 center">-->
            <!--    <a href="#file-browser-root">-->
            <!--        <i class="material-icons">error</i>-->
            <!--    </a>-->
            <!--</li>-->
            <li class="tab col s4 center">
                <a href="#hierarchy_tab">
                    <i class="material-icons" style="width:100%">work</i>
                </a>
            </li>
            <li class="tab col s4 center">
                <a href="#search_container">
                    <i class="material-icons">search</i>
                </a>
            </li>
            <li class="tab col s4 center">
                <a href="#settings">
                    <i class="material-icons">settings</i>
                </a>
            </li>

        </ul>

        <div id="file-browser" class="fileview-container">

        </div>
        <div id="hierarchy_tab">
            <span class="header toggleBelow">Open Documents<span class="material-icons">keyboard_arrow_down</span></span>
            <ul id="opendocs" class="fileview">

            </ul>
            <span class="header toggleBelow">Find file<span class="material-icons">keyboard_arrow_down</span></span>
            <div id="find_file" class="edge_box-1 h-30">
                <div class="fill_box"><input type="text" name="search_text" id="search_text" value="" /></div>
                <span id="find_file_btn" class="side-1 material-icons">search</span></div>
            
            <div id="hierarchy" class="fileview-container">
            </div>
        </div>
        <div id="search_container" class="" style="padding:15px">

            <span>Search</span>
            <div class="edge_box-2 h-50">

                <div class="fill_box input-field pb-10 inline">
                    <input id="searchInput" placeholder="Search for" type="text" class="">
                </div>

                <span id="searchbtn" class="side-1"><i class="material-icons">search</i></span>
                <span id='searchConfig' class="side-2 material-icons">view_headline</span>
            </div>
            <div class='replaceBox'>
                <span class="col s12">Replace</span>
                <div class="edge_box-2 h-50">
                    <div class="input-field inline pb-10 fill_box">
                        <input id="replaceInput" placeholder="Replace with" type="text" class="">
                    </div>
                    <span id="replacebtn" class="side-2"><i class="material-icons">autorenew</i></span>
                </div>
            </div>
            <div class="ace_search_options">
                <span id='toggleReplace' class="left material-icons">keyboard_arrow_down</span>
                <span id="toggleRegex" class="right ace_button">.*</span>
                <span id="caseSensitive" class="right ace_button">Aa</span>
                <span id="toggleWholeWord" class="right ace_button checked">[Abc]</span>
            </div>

            <div id="searchResults">

            </div>
            <span id="moreResults"><a href="#">More.....</a></span>
        </div>

        <div id="settings" style="">

        </div>

        <ul id="folder-dropdown" class="dropdown-content fileview-dropdown align-center">
            <li><a id="open-folder" href="#">Open</a></li>
            <li><a id="new-tab" href="#">Open in New Tab</a></li>
            <li><a id="open-project" href="#">Open As Project Folder</a></li>
            <li><a id="rename-folder" href="#">Rename</a></li>
            <li><a id="delete-folder" href="#">Delete</a></li>
            <li><a id="new-folder" href="#">Create folder</a></li>
            <li><a id="new-file" href="#">Create file</a></li>
            <li class="hide-if-clip-empty"><a id="paste-file" href="#">Paste</a></li>
        </ul>
        <ul id="project-folder-dropdown" class="dropdown-content fileview-dropdown align-center">
            <li><a id="open-folder" href="#">Open</a></li>
            <li><a id="rename-folder" href="#">Rename</a></li>
            <li><a id="delete-folder" href="#">Delete</a></li>
            <li><a id="new-folder" href="#">Create folder</a></li>
            <li><a id="new-file" href="#">Create file</a></li>
            <li class="hide-if-clip-empty"><a id="paste-file" href="#">Paste</a></li>
            <li><a id="show-info" href="#">Info</a></li>
            <li><a id="expand-all" href="#">Unfold Children</a></li>
            <li><a id="fold-all" href="#">Fold Children</a></li>
        </ul>
        <ul id="project-file-dropdown" class="dropdown-content fileview-dropdown align-center ">
            <li><a id="open-file" href="#">Open</a></li>
            <li><a id="rename-file" href="#">Rename</a></li>
            <li><a id="delete-file" href="#">Delete</a></li>
            <li><a id="copy-file" href="#">Copy</a></li>
            <li><a id="cut-file" href="#">Cut</a></li>
            <li class="hide-if-clip-empty"><a id="paste-file" href="#">Paste</a></li>
            <li><a id="show-info" href="#">Info</a></li>
            <li><a id="fold-parent" href="#">Fold Parent</a></li>
        </ul>
        <ul id="file-dropdown" class="dropdown-content fileview-dropdown align-center ">
            <li><a id="open-file" href="#">Open</a></li>
            <li><a id="rename-file" href="#">Rename</a></li>
            <li><a id="delete-file" href="#">Delete</a></li>
            <li><a id="copy-file" href="#">Copy</a></li>
            <li><a id="cut-file" href="#">Cut</a></li>
            <li class="hide-if-clip-empty"><a id="paste-file" href="#">Paste</a></li>
            <li><a id="show-info" href="#">Info</a></li>
        </ul>
        <ul id="create-dropdown" class="dropdown-content fileview-dropdown align-center ">
            <li><a id="new-file" href="#">New File</a></li>
            <li><a id="new-folder" href="#">New Folder</a></li>
            <li><a id="new-browser" href="#">Add Storage</a></li>
            <li><a id="delete-browser" href="#">Close Storage</a></li>
            <li class="hide-if-clip-empty"><a id="paste-file" href="#">Paste</a></li>
            <li><a id="reload-browser" href="#">Reload</a></li>
            <li><a id="add-bookmark" href="#">Add to Bookmarks</a></li>
            <li><a id="open-tree" href="#">Enable TreeView</a></li>
            <li><a id="open-project" href="#">Open as Project Folder</a></li>
                    <!--<li><a id="find-file" href="#">Find file</a></li>-->
        </ul>
    </div>


    <div id="action_bar" class="ui">
        <span class="sidenav-trigger abs-left" data-target="side-menu">
                        <i class="material-icons big menu-icon" >menu</i>
                    </span>
        <div id="status-text"><span id="status-filename" class="clipper">Open a file</span></div>

        <ul id="menu" class="tabs">
        </ul>

    </div>

    <!-- Modal Structure -->
    <div id="createBrowserModal" class="modal">
        <div class="modal-content">
            <h6>Configure Type</h6>
            <select id="browserType">
                <option value="zip">Zip file</option>
                <option value="local">Local</option>
                <option value="rest">File Server</option>
                <option disabled value="ftp">FTP</option>
                <option disabled value="dropbox">DropBox</option>
            </select>
            <div class=" config config-zip">
                <span>Pick file or leave empty to create</span>
                <input type="file" name="pickFile" id="pickFile" value="" />
            </div>
            <div class=" config config-rest">
                <span>Root Directory</span>
                <input type="text" name="rootDir" id="rootDir" value="/sdcard/" />
                <span>Address</span>
                <input type="text" name="address" id="address" value="localhost:3000" />
            </div>
            <div class=" config config-local">
                <span>Root Directory</span>
                <input type="text" name="rootDir" id="rootDir" value="/sdcard/" />
                <span>Current Directory</span>
                <input type="text" name="currentDir" id="currentDir" value="" />
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
            <a id="create" href="#!" class="modal-close waves-effect waves-green btn-flat">Done</a>
        </div>
    </div>
    <div id="searchModal" class="modal">
        <div class="modal-content blue-text">
            <div class="h-30">
                <h5>Filter Files<span class="close-icon material-icons">close</span></h5>
            </div>
            <div class="h-30">
                <input id="includeOpenDocs" class="" type="checkbox" checked="true" /><span>Search in open files</span>
            </div>
            <h6>Enter glob pattern:</h6>

            <div class="input-field inline">
                <input id="filterInput" placeholder="Search for" type="text" class="">
            </div>



            <div class="fileview-container">
                <ul class="fileview">
                </ul>
            </div>
        </div>
    </div>
    <div class="multieditor">
        <div id="editor" class="pane">

        </div>

        <div id="preview" class="pane">
        </div>
        <div id="gutter" class="gutter-h">
        </div>
        <div id="gutter-v" class="gutter-v">
        </div>

    </div>
    <div id="toolbar-toggle"><i class="material-icons">keyboard_arrow_down</i></div>

    <div id="actions">

        <div id="actions-inner" class="edge_box-1-0">
            <div class="side-1"><span id="toggleRight">{..}</span>
            </div>
            <div id="toolbar" class="fill_box">
                <span id="save" class="scroll-point"><i class="material-icons">save</i></span>
                <span id="undo"><i class="material-icons">undo</i></span>
                <span id="redo"><i  class="material-icons">redo</i></span>
                <span id="find"><i class="material-icons">search</i></span>
                <span id="shift" class="scroll-point">shift</span>
                <span id="a-left"><i class="material-icons">arrow_backward</i></span>
                <span id="a-up"><i  class="material-icons">arrow_upward</i></span>
                <span id="a-down"><i  class="material-icons">arrow_downward</i></span>
                <span id="a-right"><i class="material-icons">arrow_forward</i></span>
                <span id="openCommandPallete" class="scroll-point"><i class="material-icons">more_horiz</i></span>
                <span id="gotoline"><i class="material-icons">call_made</i></span>
                <span id="paste"><i class="material-icons">content_paste</i></span>
                <span id="copy"><i class="material-icons">content_copy</i></span>
                <span id="cut"><i class="material-icons">content_cut</i></span>
                <span id="indent"><i class="material-icons">format_indent_increase</i></span>
                <span id="outdent"><i class="material-icons">format_indent_decrease</i></span>
            </div>

            <div id="char-bar" class="fill_box">

            </div>
        </div>
    </div>
    <a id="runButton" class="btn-floating btn btn-large waves-effect waves-light teal">
        <i class="material-icons">play_arrow</i>
    </a>
    <script src="charbar.js" type="text/javascript" charset="utf-8"></script>
    <script>
        pane1 = $("#editor")[0]
        pane2 = $("#preview")[0]
        var drag_x, drag_y, new_x, new_y;
        var started = false

        function drag_start(e) {
            started = true;
            if (e.touches) {
                drag_x = e.touches[0].clientX;
                drag_y = e.touches[0].clientY;
            }
            else {
                drag_x = e.clientX;
                drag_y = e.clientY;
            }
        }

        function drag_move_x(e) {
            if (!started) return
            if (e.touches) e = e.touches[0]
            new_x = e.clientX;
            var dx = new_x - drag_x;
            var l = pane1.getBoundingClientRect()
            //if(dx<10 && dy<10)return;
            var t = ((e.clientX - l.x) / pane1.parentElement.clientWidth);
            var y = (1 - t);
            this.style.left = pane1.style.width = t * 100 + "%";
            pane2.style.width = y * 100 + "%";
            drag_x = new_x;
            pane2.innerHTML = pane2.style.width
        }

        function drag_move_y(e) {
            if (!started) return;
            if (e.touches) e = e.touches[0];
            new_y = e.clientY;
            var dy = new_y - drag_y;
            //if(dx<10 && dy<10)return;
            var l = pane1.getBoundingClientRect();
            var t = ((e.clientY - l.y) / pane1.parentElement.clientHeight);
            var y = (1 - t);
            this.style.top = pane1.style.height = t * 100 + "%";
            pane2.style.height = y * 100 + "%";
            drag_y = new_y;
            pane2.innerHTML = pane2.style.height;
        }

        function drag_stop_x(e) {
            if (!started) return;
            started = false;
            //nothing
        }

        function drag_stop_y(e) {
            if (!started) return;
            started = false;
        }
        $("#gutter")[0].addEventListener("mousedown", drag_start);
        $("#gutter")[0].addEventListener("mousemove", drag_move_x);
        $("#gutter")[0].addEventListener("mouseup", drag_stop_x);
        $("#gutter")[0].addEventListener("touchstart", drag_start);
        $("#gutter")[0].addEventListener("touchmove", drag_move_x);
        $("#gutter")[0].addEventListener("touchend", drag_stop_x);

        $("#gutter-v")[0].addEventListener("mousedown", drag_start);
        $("#gutter-v")[0].addEventListener("mousemove", drag_move_y);
        $("#gutter-v")[0].addEventListener("mouseup", drag_stop_y);
        $("#gutter-v")[0].addEventListener("touchstart", drag_start);
        $("#gutter-v")[0].addEventListener("touchmove", drag_move_y);
        $("#gutter-v")[0].addEventListener("touchend", drag_stop_y);

        $("#runButton").click(function() {
            if (window.Application) {
                if (runPaths[currentDoc]) {
                    configure("lastRun", runPaths[currentDoc]);
                    lastRun = runPaths[currentDoc];
                }
                else if (docs[currentDoc].getPath().endsWith(".html")) {
                    lastRun = "file://" + docs[currentDoc].getPath();
                    configure("lastRun", lastRun);
                }
                else if (!lastRun) {
                    alert("No file set!!!");
                    return;
                }
                window.Application.runFile(lastRun);

            }
            else {
                //iframe run
            }
        });
    </script>
    <script>
        "use strict";
        register("theme");
        var newFile = function() {
            addDoc("unsaved*", "", "temp" + new Date().getTime());
        };
        var autosave = null;
        var updateIcon = function(id) {
            if (id != currentDoc) return;
            if (!docs[currentDoc].dirty)
                $("#save i").css("color", "inherit");
            else if (docs[currentDoc].autosave)
                $("#save i").css("color", "orange")
            else {
                $("#save i").css("color", "red")
            }
        }
        var save = function(e) {
            sessionSave();
            if (docs[currentDoc].getPath().startsWith("temp")) {
                if (e === "autosave")
                    return;
                else
                    FileBrowser.saveAs(currentDoc);
            }
            else {
                if (e === "autosave")
                    saveDocs(undefined, updateIcon)
                else {
                    saveDocs(currentDoc, updateIcon)
                    if (docs[currentDoc].shadowDoc) {
                        var b = Doc.forPath(docs[currentDoc].getSavePath());
                        if (!b) {
                            b.shadowDoc = false;
                        }
                        else if (b.autosave) {
                            b.autosave = undefined
                            M.toast({ html: "Saving Duplicate Document.</b> Autosave turned off.", duration: 1000 })
                        }
                    }
                    else if (docs[currentDoc].autosave === undefined) {
                        if (docs[currentDoc].shadowDoc) {
                            docs[currentDoc].shadowDoc = undefined;
                        }
                        docs[currentDoc].autosave = appConfig.autosave;
                        if (docs[currentDoc].autosave)
                            //notify autosave
                        ;
                    }
                }

            }
            if (autosave && e != "autosave")
                clearTimeout(autosave);
            autosave = null;

        };

        var sessionsaved = null;
        var sessionSave = function() {
            clearTimeout(sessionsaved);
            sessionsaved = null;
            tempSave();
            //$("#save").children().css("color","orange")
        };


        var swapTab = function() {
            if (lastTab < 0)
                return;

            tabController.select(lastTab)
        }
        // set to false to prevent using wo"rker, which is needed to run this from local html file due to browser security restritions
        var useWebWorker = false; //window.location.search.toLowerCase().indexOf('noworker') == -1;
        var commands = ace.require("ace/commands/default_commands").commands;

        for (var a of [{
                    name: "Toggle Fullscreen",
                    bindKey: "F11",
                    exec: function(editor) {
                        $("#action_bar").toggle();
                        $(".multieditor").toggleClass("fullscreen");
                        editor.resize()
                    }
                }, {
                    name: "Toggle Split",
                    bindKey: "F10",
                    exec: function(editor) {
                        //recall sizes

                        if ($(".multieditor").hasClass("split")) {
                            $(".multieditor").children(".pane").css("width", "100%")
                            $(".multieditor").removeClass("split");
                        }
                        else {
                            if ($(".multieditor").hasClass("split-v")) {
                                $(".multieditor").children(".pane").css("height", "100%");
                                $(".multieditor").removeClass("split-v")

                            }
                            $(".multieditor").addClass("split");
                            $(".multieditor").children(".pane").css("width", "50%")
                        }
                        editor.resize()
                    }
                }, {
                    name: "Toggle Split Vertical",
                    bindKey: "F9",
                    exec: function(editor) {

                        if ($(".multieditor").hasClass("split-v")) {
                            $(".multieditor").children(".pane").css("height", "100%")
                            $(".multieditor").removeClass("split-v");
                        }
                        else {
                            if ($(".multieditor").hasClass("split")) {
                                $(".multieditor").children(".pane").css("width", "100%");
                                $(".multieditor").removeClass("split");
                            }
                            $(".multieditor").addClass("split-v");
                            $(".multieditor").children(".pane").css("height", "50%")
                        }
                        editor.resize()
                    }
                },
                {
                    name: "newFile",
                    bindKey: { win: "Ctrl-N", mac: "Command-Alt-N" },
                    exec: window.newFile
                },

                {
                    name: "swapTabs",
                    bindKey: { win: "Alt-Tab", mac: "Command-Alt-N" },
                    exec: window.swapTab
                },
                {
                    name: "save",
                    bindKey: { win: "Ctrl-S", mac: "Command-S" },
                    exec: window.save
                },
                {
                    name: "saveAs",
                    bindKey: { win: "Ctrl-Shift-S", mac: "Command-Shift-S" },
                    exec: function() {
                        FileBrowser.saveAs(currentDoc)
                    }
                }
            ]) {
            commands.push(a);
        }
        var SettingsTab = ace.require("ace/ext/options").OptionPanel;

        var _ = document.getElementById.bind(document);
        var modelist = ace.require("ace/ext/modelist");
        var themes = ace.require("ace/ext/themelist").themes.map(function(t) { return t.theme });
        var useTern = true;
        var alwaysUseTern = true;
        this.editor = ace.edit("editor");
        this.editor.on("copy", function(e) {
            clipboard = e.text;
        });
        var encodings = [
            'utf-8',
            'utf-16'].map(function(v){
                return { caption: v.toUpperCase(), value: v }
            });
        var settingsTab = new SettingsTab(this.editor, $("#settings")[0])
        settingsTab.add(
            {
                "Session":{
                    "Encoding":{
                        type:"select",
                        onchange:function(val){
                            alert(val)
                        },
                        getValue:function(defaults){
                            return 'utf-8'
                        },
                        items:encodings
                    },
                    "Read Only":{
                        type:"checkbox",
                        path:"readOnly"
                    }
                }
            })
        var settingsMenu = $('#settings');

        function updateSettings() {
            settingsTab.render()
            //settingsMenu.find('select').formSelect({ dropdownOptions: { height: 300, autoFocus: false } });
            settingsMenu.find('button').addClass('btn btn-group').parent().addClass("btn-group-container");
            settingsMenu.find('input').filter('[type=checkbox]').addClass('checkbox').after("<span></span>").next().click(function(e) { $(this).prev().click() });
        }
        updateSettings();
        this.editor.on("paste", function(e) {
            if (clipboard === undefined)
                clipboard = e.text;
        });

        this.editor.getSession().setUseWorker(true);
        var editor = this.editor;
        editor.setAutoScrollEditorIntoView(false)
        editor.getSession().setUseWrapMode(true);
        editor.getSession().setWrapLimitRange(null, null);
        editor.setShowPrintMargin(false);
        editor.$blockScrolling = Infinity; //prevents ace from logging annoying warnings
        var theme = appConfig.theme || themes[0];
        //Math.floor(themes.length * Math.random() - 1e-5)
        //if(theme>themes.indexOf("ace/theme/sqlserver"))$(document.body).addClass('theme-dark')
        editor.setTheme(theme);
        editor.getHistory = null; //getHistory.bind(editor);
        editor.setHistory = null;
        //editor.on('blur', editor_on_blur);
        const themeBlack = ["ace-tomorrow-night-bright", "ace-terminal-theme"]
        editor.renderer.on("themeLoaded", function(e) {
            $(document.body).attr('class', '').addClass(e.theme.cssClass);
            if (themeBlack.indexOf(e.theme.cssClass) > -1) $(document.body).addClass("theme-black")
            else if (e.theme.isDark) $(document.body).addClass("theme-dark")
        });
        editor.renderer.on('themeChange', function(e) {
            configure("theme", e.theme);
        })
        ace.config.loadModule("ace/ext/statusbar", function(module) {
            var StatusBar = module.StatusBar;
            new StatusBar(editor, $("#status-text")[0])
        });
        ace.config.loadModule('ace/ext/tern', function() {
            //does not deal well with script in strings
            var getJsFromMixedHtml = function(s, debug) {
                var r = ''
                var d = ''
                var inScript = false
                var lines = s.split('\n');

                for (var i = 0; i < lines.length; i++) {
                    var l = lines[i];
                    if (debug) d += '\n inScript=' + inScript + '; ' + i + '. ' + l;
                    if (inScript) {
                        if (l.match(/\s*\/script/)) {
                            inScript = false;
                            r += "\n";
                            continue;
                        }
                        r += "\n" + l;
                    }
                    else {
                        if (l.match(/\s*<script/)) {
                            if (!l.match(/src="/)) { //dont add <scirpt src lines
                                inScript = true;
                            }
                        }
                        r += "\n";
                    }
                    if (i === 0) {
                        r = r.replace("\n", ""); //dont add break for first line
                    }
                }
                if (debug) console.log('GetJsFromMixedHtml debug', d);
                return r;
            }
            editor.setOptions({
                /**
                 * Either `true` or `false` or to enable with custom options pass object that
                 * has options for tern server: http://ternjs.net/doc/manual.html#server_api
                 * If `true`, then default options will be used
                 */
                enableTern: {
                    /* http://ternjs.net/doc/manual.html#option_defs */
                    defs: ['browser', 'ecma5'],
                    /* http://ternjs.net/doc/manual.html#plugins */
                    plugins: {
                        doc_comment: {
                            fullDocs: true
                        }
                    },
                    useWorker: false,
                    /* if your editor supports switching between different files (such as tabbed interface) then tern can do this when jump to defnition of function in another file is called, but you must tell tern what to execute in order to jump to the specified file */
                    switchToDoc: function(name, pos, end) {
                        var a = editor.ternServer.docs[name]
                        var c = Doc.forPath(a.name);
                        if (c) {
                            //typically open the file I guess
                            //but should not be possible given
                            //we del docs on close
                            if (confirm("Open " + a.name)) {
                                // todo
                            }
                        }
                        Doc.swapDoc(c.id);
                        var doc = editor;
                        doc.gotoLine(pos.row, pos.column || 0); //this will make sure that the line is expanded
                        doc.getSession().unfold(pos); //gotoLine is supposed to unfold but its not working properly.. this ensures it gets unfolded

                        var sel = doc.getSelection();
                        sel.setSelectionRange({
                            start: pos,
                            end: end
                        });
                    },
                    fileFilter: function(val, name, doc) {
                        if (!doc.getMode) {
                            console.error("Tern possible Corruption: " + name)
                        }
                        if (doc.getMode().$id == "ace/mode/html") {
                            return getJsFromMixedHtml(val)
                        }
                        return val;
                    },
                    /**
                     * if passed, this function will be called once ternServer is started.
                     * This is needed when useWorker=false because the tern source files are loaded asynchronously before the server is started.
                     */
                    startedCb: function() {
                        //once tern is enabled, it can be accessed via editor.ternServer
                        console.log('ternServer started:', editor.ternServer);
                        for (var doc in docs)
                            if (ternSupportedDocs.hasOwnProperty(docs[doc].session.getMode().$id)) {
                                editor.ternServer.addDoc(docs[doc].getPath(), docs[doc].session)
                            }
                    },
                },

                enableSnippets: true,
                enableBasicAutocompletion: true,
                enableLiveAutocompletion: true,
                vScrollBarAlwaysVisible: true
            });
        });

        ace.config.loadModule('ace/ext/html_beautify', function(beautify) {
            editor.setOptions({
                // beautify when closing bracket typed in javascript or css mode
                autoBeautify: true,
                // this enables the plugin to work with hotkeys (ctrl+b to beautify)
                htmlBeautify: true,
            });

            window.beautifyOptions = beautify.options;
        });

        var EditSession = ace.require("ace/edit_session").EditSession;
    </script>
    <script>
        //var editor = ace.edit("editor");
        //editor.session.setMode("ace/mode/html");
        // enable emmet on the current editor
        //editor.setOption("enableEmmet", true);
    </script>


    <script>
        var sidenavTabCtrlR;
        var lastToggle;
        var lastTab;
        var server;
        var editor;
        var tabController;
        var _hierarchy;

        function bootEditor() {
            $("#save").click(save);

            editor.on("change", function() {
                // todo make autosave per session and
                // configurable
                docs[currentDoc].dirty = !(docs[currentDoc].safe = false)
                updateIcon(currentDoc)
                if (!autosave && docs[currentDoc].autosave) {
                    autosave = setTimeout(function() { save("autosave") }, 60000)
                }
                else if (sessionsaved) {
                    clearTimeout(sessionsaved)
                }
                sessionsaved = setTimeout(sessionSave, 100)
            });
            $(".toggleBelow").click(function(e) {
                e.stopPropagation();
                if ($(this).next().css("display") == "none"){
                    $(this).next().show()
                    $(this).children(".material-icons").text("keyboard_arrow_up")
                }
                else{
                    $(this).next().hide()
                    $(this).children(".material-icons").text("keyboard_arrow_down")
                }
            });
            $("#menu").on("click", ".close-icon", function(ev) {

                var h = $(this).parent().attr("href"); //console.log(h);
                if (!(docs[h.slice(1)].dirty) || confirm("Close without saving?")) {
                    closeDoc(h.slice(1));
                }
                ev.preventDefault();
                ev.stopPropagation();
            });
            $("#opendocs").on("click", ".file-item", function(ev) {
                var id = $(this).attr("data-file");
                var a = $(ev.target).closest(".dropdown-btn");
                if (a.length > 0) {
                    if (!(docs[id].dirty) || confirm("Close without saving?")) {
                        closeDoc(id);
                    }
                }
                else {
                    Doc.swapDoc(id);
                }
            })
            sidenavTabCtrlR = new Tab($("#selector"));
            tabController = new Tab($("#menu"))
            tabController.afterClick = function(activeLink) {
                lastTab = currentDoc;
                currentDoc = activeLink.parent().attr("data-file");
                configure("currentDoc", currentDoc)
                //console.log(activeLink[0])
                Doc.swapDoc(currentDoc, true);
                return true;
            }
            sidenavTabCtrlR.beforeClick = function(newel, oldel) {
                if (newel.attr("href") == "#settings")
                    updateSettings();
            }
            $("#menu").on("mouseover", ".tab", function(ev) {
                $("#menu").find(".close-icon").hide();
                $(this).find(".close-icon").fadeIn("fast");
            }).on("mouseleave", ".tab", function(ev) {
                $(this).find(".close-icon").fadeOut("fast")
            })


            $('#side-menu').sidenav({
                draggable: true,
                onOpenEnd: function() {
                    this.options.draggable = false;
                    setTimeout(updateSettings, 1);
                },
                onCloseEnd: function() {
                    this.options.draggable = true;
                    FileBrowser.exitSaveMode();
                }
            });
            new SearchTab(editor, $("#search_container"), $("#searchModal"));
            data_plugins = "requirejs doc_comments complete_strings";
            data_libs = "ecma5 browser jquery";

            //FileBrowsers
            FileBrowser.initDropdowns();
            FileBrowser.loadBrowsers();
            _fileBrowsers.push(new FileBrowser("file-browser"))
            //_fileBrowsers.push(new FileBrowser("file-browser", "/data/data/com.tmstudios.shunt/"))
            _fileBrowsers.push(new Hierarchy("hierarchy", ""));
            _hierarchy = _fileBrowsers.hierarchy;
            
            //File finding
            $("#find_file_btn").click(function(){
                _hierarchy.find($("#search_text").val())
            })
            //Tabs
            p = appStorage.getItem("docs");
            t = appStorage.getItem("tabs")
            if (t) {
                tabs = t.split(",");
                Doc.fromJSON(p)
                createTabs()
            }
            else if (p) {
                console.error("Possible Storage Corruption: docs without tabs")
            }
            if (Doc.numDocs() < 1) {
                newFile()
            }
            else {
                var c = function(doc) {
                    var name = filename(doc.getPath());
                    return function(res) {
                        if (res && res != doc.getValue()) {
                            if (toReload.indexOf(doc) > -1 || confirm("File changed. Reload " + name + "?")) {
                                doc.setValue(res);
                                doc.dirty = false;
                                tempSave(doc.id);
                            }
                        }
                        else doc.dirty = false;
                        updateIcon(doc.id);
                    }
                }
                for (var i in docs) {
                    if (docs[i].getPath().startsWith("temp"))
                        continue;

                    getFileServer(i).getFile(docs[i].getSavePath(), c(docs[i]));

                }
            }

        }
        $(document).ready(bootEditor);
    </script>

</body>

</html>